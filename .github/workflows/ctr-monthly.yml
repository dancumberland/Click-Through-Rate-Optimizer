# ABOUTME: GitHub Actions workflow for automated CTR optimization
# ABOUTME: Runs monthly review using Claude CLI

name: CTR Monthly Review - DCL

on:
  # Run at 6am UTC on the 1st of each month
  schedule:
    - cron: '0 6 1 * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes made)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  ctr-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js (for Claude CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Authenticate Claude CLI
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # Claude CLI uses this environment variable for auth
          echo "Claude CLI authenticated via CLAUDE_CODE_OAUTH_TOKEN"

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Set up credentials
        env:
          ENV_FILE: ${{ secrets.ENV_FILE }}
          GSC_OAUTH_JSON: ${{ secrets.GSC_OAUTH_JSON }}
          GSC_TOKEN_JSON: ${{ secrets.GSC_TOKEN_JSON }}
        run: |
          # Create .env file with site configuration
          echo "$ENV_FILE" > .env

          # Create credentials directory
          mkdir -p credentials

          # Write GSC credentials
          echo "$GSC_OAUTH_JSON" > credentials/gsc_oauth.json
          echo "$GSC_TOKEN_JSON" > credentials/gsc_token.json

      - name: Initialize database
        run: |
          sqlite3 site_crawl.db < ctr_system/schema.sql
          echo "Database initialized with schema"

      - name: Run CTR Monthly Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            python scripts/ctr_orchestrator.py monthly --dry-run
          else
            python scripts/ctr_orchestrator.py monthly
          fi

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ctr-report-${{ github.run_number }}
          path: CTR_Reports/
          retention-days: 90

      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: database-${{ github.run_number }}
          path: site_crawl.db
          retention-days: 30
